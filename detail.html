<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUTHORITIES</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{ --accent-blue:#1976d2; --accent-green:#388e3c; --max-width:900px; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Arial, sans-serif; background:#f6f8fb; color:#102a43; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    header{ height:88px; display:flex; align-items:center; justify-content:center; background:linear-gradient(90deg,var(--accent-blue),var(--accent-green)); color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.12); }
    header h1{ margin:0; font-size:1.4rem; letter-spacing:1px; }
    main{ max-width:var(--max-width); margin:28px auto; padding:0 16px; }
    .card{ background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(8,30,50,0.06); overflow:hidden; }
    .card-header{ padding:20px; border-bottom:1px solid #eef4fb; display:flex; align-items:center; gap:12px; }
    .card-header h2{ margin:0; font-size:1.15rem; color:#0b2540; }
    .card-body{ padding:20px; line-height:1.65; font-size:15px; color:#123; }
    .no-data{ padding:28px; text-align:center; color:#9aa5b1; font-style:italic; }
    @media (max-width:520px){ main{ margin:14px 10px; } .card-header{ padding:14px } .card-body{ padding:14px } }
  </style>
</head>
<body>
  <header role="banner" aria-label="Header">
    <h1>AUTHORITIES</h1>
  </header>

  <main role="main" aria-live="polite">
    <div class="card" id="card">
      <div class="card-header">
        <h2 id="title">Loading…</h2>
      </div>
      <article id="fragmentContainer" class="card-body">
        <div class="no-data">Loading content…</div>
      </article>
    </div>
  </main>

  <script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js"></script>
  <script>
    function qs(name){ return new URLSearchParams(window.location.search).get(name); }
    function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    (async function(){
      const fragmentParam = qs('fragment');
      const titleParam = qs('title');
      const titleEl = document.getElementById('title');
      const container = document.getElementById('fragmentContainer');

      // If fragment passed, load it and render sanitized HTML
      if (fragmentParam) {
        titleEl.textContent = titleParam || fragmentParam.split('/').pop();
        try {
          const res = await fetch('./fragments/' + fragmentParam, {cache:'no-cache'});
          if (!res.ok) throw new Error('Not found: ' + res.status);
          const html = await res.text();
          container.innerHTML = DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['section','h1','h2','h3','h4','p','ul','ol','li','dl','dt','dd','strong','em','br','table','tr','td'],
            ALLOWED_ATTR: ['class','id']
          });
          return;
        } catch (err) {
          container.innerHTML = '<div class="no-data">Could not load content: ' + escapeHtml(err.message) + '</div>';
          return;
        }
      }

      // fallback: try simple system/circ/sub resolution via map.json
      const system = qs('system');
      const circ = qs('circ');
      const sub = qs('sub');
      if (system && circ) {
        try {
          const mapRes = await fetch('./fragments/map.json', {cache:'no-cache'});
          if (mapRes.ok) {
            const map = await mapRes.json();
            let mapped = null;
            if (sub && map[system] && map[system][circ] && typeof map[system][circ] === 'object') {
              mapped = map[system][circ][sub];
            } else if (map[system] && map[system][circ] && typeof map[system][circ] === 'string') {
              mapped = map[system][circ];
            }
            if (mapped) {
              titleEl.textContent = titleParam || (sub || circ);
              const res = await fetch('./fragments/' + mapped, {cache:'no-cache'});
              if (!res.ok) throw new Error('Not found: ' + res.status);
              const html = await res.text();
              container.innerHTML = DOMPurify.sanitize(html, {ALLOWED_TAGS: ['section','h1','h2','h3','h4','p','ul','ol','li','dl','dt','dd','strong','em','br'], ALLOWED_ATTR:['class','id']});
              return;
            }
          }
        } catch (err) {
          console.error(err);
        }
      }

      // final fallback
      titleEl.textContent = titleParam || 'Details';
      container.innerHTML = '<div class="no-data">No content available.</div>';
    })();
  </script>
</body>
</html>
