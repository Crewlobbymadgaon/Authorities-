<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Block Working System (Fragments Demo)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{
  --header-height: 88px;
  --accent-blue: #1976d2;
  --accent-green: #388e3c;
}
html,body { height:100%; margin:0; font-family:Arial, sans-serif; background:#f9f9f9; overflow:hidden; }
header { height:var(--header-height); background:linear-gradient(90deg,var(--accent-blue),var(--accent-green)); padding:20px 15px; position:sticky; top:0; z-index:100; box-shadow:0 4px 8px rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center; }
#mainHeading { font-size:2.0rem; color:white; margin:0; letter-spacing:1px; text-align:center; }
.app { display:flex; flex-direction:column; height:calc(100% - var(--header-height)); }
#selectionPage { padding:18px; overflow-y:auto; flex:1 1 auto; }
#systemPage { display:none; flex-direction:column; height:100%; }
.subheader { display:flex; align-items:center; justify-content:center; background:#fff; padding:12px 20px; border-bottom:2px solid #ddd; position:sticky; top:var(--header-height); z-index:99; }
#systemTitle { font-size:1.4rem; color:#333; margin:0; text-align:center; }
#systemMain { flex:1 1 auto; overflow-y:auto; padding:20px; outline:none; }
.block-container { display:flex; justify-content:center; gap:20px; margin-top:30px; flex-wrap:wrap; }
.block { flex:1 1 200px; max-width:300px; height:150px; display:flex; align-items:center; justify-content:center; font-size:1.1rem; font-weight:700; color:white; border-radius:12px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:transform .22s ease, opacity .22s; text-align:center; }
.block.abs { background:var(--accent-blue); }
.block.auto { background:var(--accent-green); }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin:20px auto; max-width:980px; }
.grid-item { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.08); font-size:1.05rem; font-weight:700; cursor:pointer; transition:transform .18s, background .18s; text-align:center; line-height:1.25; user-select:none; }
.grid-item:hover { background:var(--accent-blue); color:white; transform:translateY(-4px) scale(1.02); }
.block:focus { outline: none; transform: translateY(-2px) scale(1.02); }
.block:focus-visible { box-shadow: 0 0 0 4px rgba(25,118,210,0.12); }
@media (max-width:520px) { #mainHeading{font-size:1.6rem;} #systemTitle{font-size:1.15rem;} .block{height:120px;font-size:1rem;} .grid-item{padding:14px;font-size:0.98rem;} }
</style>
</head>
<body>
<header><h1 id="mainHeading">AUTHORITIES</h1></header>

<div class="app" role="application">
  <div id="selectionPage" role="main" aria-label="System selection">
    <div class="block-container" role="list" aria-label="Systems list">
      <div class="block abs" tabindex="0" role="listitem" data-system="Absolute Block System">Absolute Block System</div>
      <div class="block auto" tabindex="0" role="listitem" data-system="Automatic Block Section">Automatic Block Section</div>
    </div>
  </div>

  <div id="systemPage" aria-hidden="true">
    <div class="subheader"><h2 id="systemTitle"></h2></div>
    <main id="systemMain" tabindex="0" role="region" aria-label="System content">
      <div id="circumstancesGrid" class="grid" aria-label="Circumstances list" role="list"></div>
      <div id="subMenuGrid" class="grid" aria-label="Submenu list" role="list" style="display:none;"></div>
    </main>
  </div>
</div>

<script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js"></script>
<script>
/* minimal, clean script */
let fragmentMap = null;
let currentSystem = '';
function el(id){ return document.getElementById(id); }

/* load map.json */
async function loadFragmentMap(){
  if (fragmentMap) return fragmentMap;
  try {
    const res = await fetch('./fragments/map.json', {cache:'no-cache'});
    if (!res.ok) throw new Error('map.json not found: ' + res.status);
    fragmentMap = await res.json();
    return fragmentMap;
  } catch (err) {
    console.error(err);
    fragmentMap = {};
    return fragmentMap;
  }
}

/* resolve path helpers */
function resolveMapPath(map, keys){
  let node = map;
  for (const k of keys){
    if (node && typeof node === 'object' && k in node) node = node[k];
    else return null;
  }
  return node;
}

/* select a system */
async function selectSystem(systemName){
  currentSystem = systemName;
  el('selectionPage').style.display = 'none';
  el('systemPage').style.display = 'block';
  el('systemTitle').textContent = systemName;

  const map = await loadFragmentMap();
  const systemMap = map[systemName] || {};
  const grid = el('circumstancesGrid');
  grid.innerHTML = '';
  el('subMenuGrid').style.display = 'none';
  el('subMenuGrid').innerHTML = '';

  Object.keys(systemMap).forEach(circ => {
    const d = document.createElement('div');
    d.className = 'grid-item';
    d.tabIndex = 0;
    d.textContent = circ;
    d.addEventListener('click', () => onCircClick(circ));
    d.addEventListener('keydown', (e) => { if (e.key === 'Enter') onCircClick(circ); });
    grid.appendChild(d);
  });
}

/* when a circumstance clicked */
async function onCircClick(circ){
  const map = await loadFragmentMap();
  const subData = map[currentSystem] && map[currentSystem][circ];

  // if direct fragment string -> navigate to detail
  if (typeof subData === 'string' || circ === "TIC on Single Line") {
    const mapped = resolveMapPath(map, [currentSystem, circ]);
    if (mapped && typeof mapped === 'string') {
      const qs = new URLSearchParams({ fragment: mapped, title: circ });
      window.location.href = `detail.html?${qs.toString()}`;
    } else {
      const qs = new URLSearchParams({ system: currentSystem, circ: circ });
      window.location.href = `detail.html?${qs.toString()}`;
    }
    return;
  }

  // if not object -> fallback navigate
  if (!subData || typeof subData !== 'object') {
    const mapped = resolveMapPath(map, [currentSystem, circ]);
    if (mapped && typeof mapped === 'string') {
      const qs = new URLSearchParams({ fragment: mapped, title: circ });
      window.location.href = `detail.html?${qs.toString()}`;
    } else {
      const qs = new URLSearchParams({ system: currentSystem, circ: circ });
      window.location.href = `detail.html?${qs.toString()}`;
    }
    return;
  }

  // subData is object -> render submenu grid (no auto-open)
  const subGrid = el('subMenuGrid');
  subGrid.innerHTML = '';
  Object.keys(subData).forEach(sub => {
    const s = document.createElement('div');
    s.className = 'grid-item';
    s.tabIndex = 0;
    s.textContent = sub;
    s.addEventListener('click', () => {
      const mapped = resolveMapPath(map, [currentSystem, circ, sub]);
      if (mapped && typeof mapped === 'string') {
        const qs = new URLSearchParams({ fragment: mapped, title: sub });
        window.location.href = `detail.html?${qs.toString()}`;
      } else {
        const qs = new URLSearchParams({ system: currentSystem, circ: circ, sub: sub });
        window.location.href = `detail.html?${qs.toString()}`;
      }
    });
    s.addEventListener('keydown', (e)=> { if (e.key === 'Enter') s.click(); });
    subGrid.appendChild(s);
  });
  el('circumstancesGrid').style.display = 'none';
  subGrid.style.display = 'grid';
}

/* wire system tiles */
document.querySelectorAll('.block').forEach(b => {
  b.addEventListener('click', () => selectSystem(b.dataset.system));
  b.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectSystem(b.dataset.system);} });
});

/* initial focus */
window.addEventListener('load', () => setTimeout(()=> document.querySelector('.block')?.focus(), 80));

/* diagnostic console (if you still see issues) */
document.addEventListener('click', (e) => {
  const t = e.target.closest && e.target.closest('.block, .grid-item');
  if (t) console.log('CLICK', t.textContent.trim());
});
window.addEventListener('error', (ev) => console.error('PAGE ERROR', ev.error || ev.message || ev));
</script>
</body>
</html>
